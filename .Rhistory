Pinus = sum(Pinus, na.rm = T),
Quercus = sum(Quercus, na.rm = T)) |>
arrange(desc(age))
composite_join_bin |> filter(age > 700)
head(composite_join_bin)
diff(composite_join_bin$bins)
co2 <- co2[nrow(co2):1, , drop = F]
co2_bins <- cut(co2$age_calBP, breaks = seq(from = min(composite_join$age),
to = max(composite_join$age + bin_width),
by = bin_width),
include.lowest = T, labels = F)
co2_clip <- cbind(co2_bins, co2) |>
drop_na(co2_bins) |>
select(co2_bins, age_calBP, CO2_blank_gravity_corrected) |>
group_by(co2_bins) |>
summarise(mean_age_co2 = mean(age_calBP),
mean_co2 = mean(CO2_blank_gravity_corrected)) |>
arrange(desc(mean_age_co2))
# Check Heinrich intervals!
# Check humans with Jack (going with post 20Kabp)
# Log transform ocfs unnecessary with scaling?
oxy18_mean <- oxy18 |>
rename(age = Age) |>
group_by(age) |>
summarise(d18O = mean(d18O)) |>
arrange(desc(age)) |>
mutate(heinrich = NA,
heinrich = case_when(age <= 62400 & age >= 59700 ~ 1,
age <= 49300 & age >= 47600 ~ 1,
age <= 40200 & age >= 36800 ~ 1,
age <= 31300 & age >= 30000 ~ 1,
age <= 24700 & age >= 23400 ~ 1,
age <= 18300 & age >= 15100 ~ 1,
age <= 12900 & age >= 11000 ~ 1,
.default = NA),
humans = NA,
humans = case_when(age  <= 20000 ~ 1, .default = NA))
oxy_bins <- cut(oxy18_mean$age, breaks = seq(from = min(composite_join$age),
to = max(composite_join$age + bin_width),
by = bin_width),
include.lowest = T, labels = F)
oxy18_mean <- cbind(oxy_bins, oxy18_mean) |>
drop_na(oxy_bins) |>
group_by(oxy_bins) |>
summarise(mean_age_oxy = mean(age),
d18O = mean(d18O),
humans = mean(humans, na.rm = T),
heinrich = mean(heinrich, na.rm = T)) |>
mutate(heinrich = ifelse(is.nan(heinrich), 0, heinrich),
humans = ifelse(is.nan(humans), 0, humans)) |>
arrange(desc(mean_age_oxy))
dim(oxy18_mean)
dim(co2_clip)
oxy_co2 <- full_join(oxy18_mean, co2_clip, by = c("oxy_bins" = "co2_bins"))
oxy_co2
dim(oxy_co2)
colSums(is.na(oxy_co2))
oxy_co2 |>
pivot_longer(-c(oxy_bins, mean_age_oxy, mean_age_co2)) |>
ggplot(aes(x = oxy_bins, y = value)) +
geom_point() +
geom_line() +
geom_smooth() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite <- full_join(composite_join_bin, oxy_co2, by = c("bins" = "oxy_bins"))
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp)) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
# set up Y
Y <- all_composite |>
select(other, Grass, Herbs, Pinus, Quercus) |>
as.matrix()
Tsample <- which(rowSums(Y) != 0)
all_composite |>
select(other, Grass, Herbs, Pinus, Quercus)
all_composite
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp))
X <- all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp)) |>
as.matrix() |>
scale()
X
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp))
# set up X with temp
X <- all_composite |>
select(char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp)) |>
as.matrix() |>
scale()
p <- ncol(X) + 1 # Number of independent variables plus intercept
n <- ncol(Y)
V.fixed = diag(n) # Covariance matrix of environmental variation in process eq
B.fixed <- matrix(c(rep(0,p),rep(NA, (n - 1) * p)), p, n)
B.start <- matrix(c(rep(0,p),rep(.01, (n - 1) * p)), p, n)
glmm_mod <- multinomialTS::mnGLMM(Y = Y[which(rowSums(Y) != 0),],
X = X[which(rowSums(Y) != 0), ,drop = F],
B.start = B.start, B.fixed = B.fixed,
V.fixed = V.fixed)
summary(glmm_mod)
B0.start <- glmm_mod$B[1, , drop = F]
B.start <- glmm_mod$B[2:p, , drop = F]
B.start
B0.start <- glmm_mod$B[1, , drop = F]
B.start <- glmm_mod$B[2:p, , drop = F]
sigma.start <- glmm_mod$sigma
V.fixed = matrix(NA, n, n) # Covariance matrix of environmental variation in process eq
V.fixed[1] = 1
V.start <- glmm_mod$V
B.fixed <- matrix(NA, ncol(X), n)
B.fixed[,1] <- 0
B0.fixed = matrix(c(0, rep(NA, n - 1)), nrow = 1, ncol = n)
# Set-up C without interactions
C.start.diag = .5 * diag(n)
C.fixed.diag <- C.start.diag
C.fixed.diag[C.fixed.diag != 0] <- NA
# Model with no interactions
start_time <- Sys.time()
mnTS_mod <- mnTS(Y = Y,
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
B0.start
B0.fixed
B.start
B.fixed
C.start.diag
C.fixed
C.start.diag
C.fixed.diag
V.start
V.fixed
# Model with no interactions
start_time <- Sys.time()
mnTS_mod <- mnTS(Y = Y,
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
B0.start
B.start
glmm_mod$B
V.fixed
V.start
B.fixed <- matrix(NA, ncol(X), n)
B.fixed
B.fixed
B0.fixed
# Model with no interactions
start_time <- Sys.time()
mnTS_mod <- mnTS(Y = Y,
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
summary(glmm_mod)
sigma.start
B.fixed
B.fixed
B.fixed <- matrix(NA, ncol(X), n)
B.fixed[,1] <- 0
B.fixed
B0.start <- glmm_mod$B[1, , drop = F]
B.start <- glmm_mod$B[2:p, , drop = F]
sigma.start <- glmm_mod$sigma
V.fixed = matrix(NA, n, n) # Covariance matrix of environmental variation in process eq
V.fixed[1] = 1
V.start <- glmm_mod$V
# V.start <- diag(diag(V.start))
B.fixed <- matrix(NA, ncol(X), n)
B.fixed[,1] <- 0
B0.fixed = matrix(c(0, rep(NA, n - 1)), nrow = 1, ncol = n)
# Set-up C without interactions
C.start.diag = .5 * diag(n)
C.fixed.diag <- C.start.diag
C.fixed.diag[C.fixed.diag != 0] <- NA
# Model with no interactions
start_time <- Sys.time()
mnTS_mod <- mnTS(Y = Y,
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
B0.fixed
B.fixed
C.start.diag
C.fixed.diag
C.fixed.diag
Y
X
Tsample
B0.start
B0.fixed
B.start
B.fixed
C.start.diag
C.fixed.diag
V.start
V.fixed
mnTS(Y = Y,
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
Y[Tsample, ]
mnTS_mod <- mnTS(Y = Y[Tsample, ],
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
Y
start_time <- Sys.time()
mnTS_mod <- mnTS(Y = Y[Tsample, ],
X = X, Tsample = Tsample,
B0.start = B0.start, B0.fixed = B0.fixed,
B.start = B.start, B.fixed = B.fixed,
C.start = C.start.diag, C.fixed = C.fixed.diag,
V.start = V.start, V.fixed = V.fixed,
dispersion.fixed = 1, maxit.optim = 1e+6)
end_time <- Sys.time()
end_time - start_time
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp)) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
co2 <- read_csv("./data/co2_merged.csv")
co2
if (!require("pacman")) install.packages("pacman", repos="http://cran.r-project.org")
pacman::p_load(multinomialTS, tidyverse, ggtext, patchwork, forecast, viridis, viridisLite, RColorBrewer)
# grimm_06_pollen <- get_sites(siteid = 2570) |>
#   get_datasets() |>
#   neotoma2::filter(datasettype == "pollen" & !is.na(age_range_young)) |>
#   get_downloads() |>
#   samples()
#
# saveRDS(grimm_06_pollen, "./data/data_230814/grimm_06_pollen.rds")
chron <- read_csv("./data/TULA20_compsiteCore_w-ages.csv")
grimm_06_pollen <- readRDS("./data/grimm_06_pollen.rds")
core_20_char <- read_csv("./data/TULA20_CHAR_w-ages.csv")
core_20_spore <- read_csv("./data/TULA20_CFS_w-ages.csv")
# core_20_loi <- read_csv("./data/TULA20_LOI_w-ages.csv")
co2 <- read_csv("./data/co2_merged.csv")
oxy18 <- read_csv("./data/ngrip-d18o-50yr.csv")
chron <- chron |>
select(depth_composite, median_age, quant_5perc, quant_95perc)
colnames(chron) <- c("depth", "age", "age_lower", "age_upper")
core_20_char <- core_20_char |>
select(depth_composite, accu_rate)
colnames(core_20_char) <- c("depth", "char_acc")
core_20_spore <- core_20_spore |>
select(depth_composite, `OCFS Concentration`)
colnames(core_20_spore) <- c("depth" , "ocfs")
# core_20_loi <- core_20_loi |>
#   select(depth_composite, pctOrg)
# colnames(core_20_loi) <- c("depth", "loi")
#
# full_join(core_20_char, core_20_loi)
# Variations in tree cover in North America since the LGM
# graminoids/grass
# Herbs/Forbs
herbs <- c("Apiaceae.*|Ambrosia.*|Artemisia.*|Asteraceae.*|
Tubuliflorae.*|Brassicaceae.*|Caryophyllaceae.*|
Chenopodiaceae.*|Amaranthaceae.*|Dryas.*|Ephedra.*|
Eriogonum.*|Euphorbiaceae.*|Oxyria.*|Ranunculaceae.*|
Sarcobatus.*|Saxifragaceae.*")
grass <- c("Cyperaceae.*|Poaceae.*")
herb_forb <- grimm_06_pollen |>
dplyr::filter(datasetid == 19620,
stringr::str_detect(variablename, herbs)) |>
mutate(variablename = "Herbs") |>
group_by(siteid, sitename,
sampleid, variablename, units, age,
agetype, depth, datasetid,
long, lat) |>
summarise(value = sum(value), .groups='keep')
gram_grass <- grimm_06_pollen |>
dplyr::filter(datasetid == 19620,
stringr::str_detect(variablename, grass)) |>
mutate(variablename = "Grass") |>
group_by(siteid, sitename,
sampleid, variablename, units, age,
agetype, depth, datasetid,
long, lat) |>
summarise(value = sum(value), .groups='keep')
grimm_06_tree <- grimm_06_pollen |>
dplyr::filter(datasetid == 19620,
ecologicalgroup %in% c("UPHE", "TRSH"),
stringr::str_detect(variablename, c("Pinus.*|Quercus.*"))
) |>
mutate(variablename = replace(variablename, stringr::str_detect(variablename, "Pinus.*"), "Pinus"),
variablename = replace(variablename, stringr::str_detect(variablename, "Picea.*"), "Picea")) |>
group_by(siteid, sitename,
sampleid, variablename, units, age,
agetype, depth, datasetid,
long, lat) |>
summarise(value = sum(value), .groups='keep')
other_spp <- grimm_06_pollen |>
dplyr::filter(datasetid == 19620,
ecologicalgroup %in% c("UPHE", "TRSH"),
!stringr::str_detect(variablename, herbs),
!stringr::str_detect(variablename, grass),
!stringr::str_detect(variablename, c("Pinus.*|Quercus.*"))) |>
mutate(variablename = "other") |>
group_by(siteid, sitename,
sampleid, variablename, units, age,
agetype, depth, datasetid,
long, lat) |>
summarise(value = sum(value), .groups='keep')
grimm_06_groups <- bind_rows(other_spp, gram_grass, herb_forb, grimm_06_tree)
grimm_06_pollen_wide <- grimm_06_groups |>
pivot_wider(id_cols = c(depth, age), names_from = variablename, values_from = value) |>
mutate(across(c(other, Grass, Herbs, Pinus, Quercus), ~ replace_na(., 0))) |>
rename("grimm_age" = "age")
dim(chron)
composite_join <- chron |>
full_join(grimm_06_pollen_wide, by = "depth") |>
full_join(core_20_char, by = "depth") |>
full_join(core_20_spore, by = "depth") |>
filter(depth >= min(grimm_06_pollen_wide$depth),
depth <= max(grimm_06_pollen_wide$depth)) |>
arrange(desc(age))
dim(composite_join)
composite_join |> filter(depth < 75, depth > 65)
# Clip from first to last pollen samples
composite_join_pollen <- composite_join |>
select(depth, age, grimm_age, other, Grass, Herbs, Pinus, Quercus) |>
pivot_longer(-c(depth, age, grimm_age))
grimm_labels <- composite_join_pollen |>
filter(!is.na(grimm_age)) |>
distinct(age, grimm_age) |>
slice(seq(from = 1, to = 191, by = 20), 191)
plot(composite_join_pollen$age, composite_join_pollen$grimm_age, type = 'l')
composite_join_pollen |>
ggplot(aes(x = age, y = value)) +
geom_area(fill = "grey20") +
geom_segment(data = composite_join_pollen,
aes(x = age, xend = age,
y = 0, yend = value), colour = "grey30", linewidth = 0.6) +
geom_vline(data = grimm_labels, aes(xintercept = age),
color = "red", linetype = "dashed") +
geom_text(data = grimm_labels,
aes(y = 400,
x = age,
label = paste0("Grimm: ", grimm_age)),
vjust = 0, size = 3) +
scale_x_reverse(breaks = scales::breaks_pretty(n = 6)) +
coord_flip() +
labs(y = "Pollen counts", x = "Time (ybp)") +
facet_wrap(~name, nrow = 1) +
theme_minimal() +
theme(
text = element_text(size = 9),
)
composite_join_cov <- composite_join |>
select(depth, age, char_acc, ocfs) |>
filter(depth >= min(grimm_06_pollen_wide$depth),
depth <= max(grimm_06_pollen_wide$depth)) |>
pivot_longer(-c(depth, age)) |>
arrange(desc(age))
composite_join_cov |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
scale_x_reverse(breaks = scales::breaks_pretty(n = 6)) +
coord_flip() +
labs(x = "Time (ybp)") +
facet_wrap(~name, nrow = 1, scales = "free") +
theme_minimal() +
theme(
text = element_text(size = 9),
)
bin_width = 200
bins <- cut(composite_join$age, breaks = seq(from = min(composite_join$age),
to = max(composite_join$age + bin_width),
by = bin_width),
include.lowest = T, labels = F)
composite_join_bin <- bind_cols(bins = bins, composite_join) |>
group_by(bins) |>
summarise(
age = mean(age, na.rm = T),
char_acc = mean(char_acc, na.rm = T),
ocfs = mean(ocfs, na.rm = T),
other = sum(other, na.rm = T),
Grass = sum(Grass, na.rm = T),
Herbs = sum(Herbs, na.rm = T),
Pinus = sum(Pinus, na.rm = T),
Quercus = sum(Quercus, na.rm = T)) |>
arrange(desc(age))
composite_join_bin |> filter(age > 700)
### CO2
co2 <- co2[nrow(co2):1, , drop = F]
co2_bins <- cut(co2$age_calBP, breaks = seq(from = min(composite_join$age),
to = max(composite_join$age + bin_width),
by = bin_width),
include.lowest = T, labels = F)
co2_clip <- cbind(co2_bins, co2) |>
drop_na(co2_bins) |>
select(co2_bins, age_calBP, CO2_blank_gravity_corrected) |>
group_by(co2_bins) |>
summarise(mean_age_co2 = mean(age_calBP),
mean_co2 = mean(CO2_blank_gravity_corrected)) |>
arrange(desc(mean_age_co2))
### Oxy18
# Check Heinrich intervals!
# Check humans with Jack (going with post 20Kabp)
# Log transform ocfs unnecessary with scaling?
oxy18_mean <- oxy18 |>
rename(age = Age) |>
group_by(age) |>
summarise(d18O = mean(d18O)) |>
arrange(desc(age)) |>
mutate(heinrich = NA,
heinrich = case_when(age <= 62400 & age >= 59700 ~ 1,
age <= 49300 & age >= 47600 ~ 1,
age <= 40200 & age >= 36800 ~ 1,
age <= 31300 & age >= 30000 ~ 1,
age <= 24700 & age >= 23400 ~ 1,
age <= 18300 & age >= 15100 ~ 1,
age <= 12900 & age >= 11000 ~ 1,
.default = NA),
humans = NA,
humans = case_when(age  <= 20000 ~ 1, .default = NA))
oxy_bins <- cut(oxy18_mean$age, breaks = seq(from = min(composite_join$age),
to = max(composite_join$age + bin_width),
by = bin_width),
include.lowest = T, labels = F)
oxy18_mean <- cbind(oxy_bins, oxy18_mean) |>
drop_na(oxy_bins) |>
group_by(oxy_bins) |>
summarise(mean_age_oxy = mean(age),
d18O = mean(d18O),
humans = mean(humans, na.rm = T),
heinrich = mean(heinrich, na.rm = T)) |>
mutate(heinrich = ifelse(is.nan(heinrich), 0, heinrich),
humans = ifelse(is.nan(humans), 0, humans)) |>
arrange(desc(mean_age_oxy))
###
dim(oxy18_mean)
dim(co2_clip)
oxy_co2 <- full_join(oxy18_mean, co2_clip, by = c("oxy_bins" = "co2_bins"))
dim(oxy_co2)
colSums(is.na(oxy_co2))
oxy_co2 |>
pivot_longer(-c(oxy_bins, mean_age_oxy, mean_age_co2)) |>
ggplot(aes(x = oxy_bins, y = value)) +
geom_point() +
geom_line() +
geom_smooth() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite <- full_join(composite_join_bin, oxy_co2, by = c("bins" = "oxy_bins"))
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
mutate(across(c(char_acc, ocfs, d18O, mean_co2), forecast::na.interp)) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
all_composite |>
select(age, char_acc, ocfs, d18O, humans, heinrich, mean_co2) |>
pivot_longer(-c(age)) |>
ggplot(aes(x = age, y = value)) +
geom_point() +
geom_line() +
facet_wrap(~name, scales = "free", ncol = 1)
